<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbz1pYybOV6YJ2YZl9laB3sqdLGDgNxz86_A3SIayyxfzgCxgtU5MgqRWaDsxj9F03YV/exec";
  const list = document.getElementById('giftList');
  const searchInput = document.getElementById('searchInput');
  let gifts = [];

  async function carregarPresentes() {
    const res = await fetch(API_URL);
    gifts = await res.json();
    renderGifts();
  }

  function renderGifts() {
    const query = searchInput.value.toLowerCase();
    list.innerHTML = '';
    gifts.forEach((gift, index) => {
      if (!gift.nome.toLowerCase().includes(query)) return;
      const card = document.createElement('div');
      card.className = 'gift-card' + (gift.indisponivel === true || gift.indisponivel === "true" ? ' unavailable' : '');
      card.innerHTML = `
        <img src="${gift.imagem}" alt="${gift.nome}">
        <h3>${gift.nome}</h3>
        <a href="${gift.link}" target="_blank">Ver presente</a><br>
        <button class="status-button">${gift.indisponivel === "true" || gift.indisponivel === true ? 'Marcar como Disponível' : 'Marcar como Indisponível'}</button>
        <button class="share-btn" onclick="compartilharWhatsApp('${gift.nome}', '${gift.link}')">Compartilhar no WhatsApp</button>
      `;
      const statusBtn = card.querySelector('.status-button');
      statusBtn.addEventListener('click', () => {
        gifts[index].indisponivel = !(gift.indisponivel === "true" || gift.indisponivel === true);
        atualizarDisponibilidade(gift.nome, gifts[index].indisponivel);
      });
      list.appendChild(card);
    });
  }

  async function atualizarDisponibilidade(nome, indisponivel) {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ nome, indisponivel }),
      headers: {
        'Content-Type': 'application/json'
      }
    });
    carregarPresentes(); // Recarrega tudo após salvar
  }

  function compartilharWhatsApp(nome, link) {
    const mensagem = `Olha esse presente na minha lista de Chá de Casa Nova: ${nome} - ${link}`;
    const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
    window.open(url, '_blank');
  }

  searchInput.addEventListener('keyup', renderGifts);
  carregarPresentes();
</script>
